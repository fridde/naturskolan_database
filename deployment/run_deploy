#!/bin/bash

echo "Have you..."
echo "1. run filecomparer?"
echo "2. Committed and pushed all changes inside the toolbox directories?"

read -e yn
    case $yn in
        [Yy]* ) ;;
        [Nn]* ) exit;;
        * ) echo "Please answer yes or no.";;
    esac

#Variable names
PROJECT_NAME=naturskolan_database
PROJECT_PATH=~/$PROJECT_NAME
STAGING_PATH=/cygdrive/d/staging/$PROJECT_NAME
GITHUB_PROJECT=https://github.com/fridde/naturskolan_database.git

set -x
trap read debug

cd $PROJECT_PATH/misc
php -e export_database.php default
php -e export_database.php just_data

cd $PROJECT_PATH

composer update
git status

read -p "Is the .gitignore file correctly configured?" yn
    case $yn in
        [Yy]* ) ;;
        [Nn]* ) exit;;
        * ) echo "Please answer yes or no.";;
    esac

git add -A
git commit -m "More work"
git push

cd $STAGING_PATH/../
chmod -R 0777 $PROJECT_NAME
mv $PROJECT_NAME oldproject_`date '+%Y%m%d_%H%M%S'`

git clone --depth 1 $GITHUB_PROJECT
cd $PROJECT_NAME
composer install --no-dev

cp $PROJECT_PATH/deployment/deployment.ini $STAGING_PATH/deployment/deployment.ini
cp $PROJECT_PATH/config/settings_prod.yml $STAGING_PATH/config/settings.yml

./vendor/bin/deployment deployment/deployment.ini
