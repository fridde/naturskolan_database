{%- extends "admin/admin_area.twig" -%}

{# DATA.current_year #}

{%- set topics, groups_by_users = DATA.topics, DATA.groups_by_users -%}
{% set missing_text = {
    group: {
    'number_students': 'Antal elever',
    'food': 'Specialkost',
    'info': 'Övrig information om klassen som kan vara bra för oss att veta'
    },
    user: {
        'mobil': 'Ditt mobilnummer'
    }
} %}

{%- block content -%}
{% for segment, users in DATA.users_by_segments %}

    {% for user in users %}
        {%- set groups = groups_by_users[user.id] -%}
        {%- set next_visit = user.next_visit -%}
        {%- set next_topic = topics[next_visit.topic_id] -%}
        {%- set missing = [] -%}

        <h1>Hej {{ user.fname }}!</h1>
        <p>Vårterminen 2019 och höstterminen 2019 är du och
            {% if groups|length == 1 %} din klass {% else %} dina klasser {% endif %}
            {{- user.group_names|join(', ', ' och ') }}
            inbokade på sex besök hos Sigtuna Naturskola. <br>Välkommen!</p>

        <p>Nästa (och kanske första dag för dig) heter {{ next_topic.name }} och är på {{ next_visit.date }}. All information om dagen finns på <a href="{{ next_topic.url }}">temadagens informationssida</a>.<br>
            Där ser du också om du och klassen blir hämtade av en buss (som vi beställer) och om du behöver ta med mat eller inte.
        </p>
        <p>
            Temat för de sex dagarna är ”Din omgivning”. Vad finns i den omgivande naturen? Vad ser du när du tittar dig omkring? Du hittar all information på
            <a href="http://www.sigtunanaturskola.se/">www.sigtunanaturskola.se</a> . Kolla gärna igenom innehållet i dagarna, så du vet hur de kan passa in i din undervisning. Det slutliga målet med våra dagar är att eleven ska bli en miljömedveten ”planetskötare”.
        </p>

        <h2>Här är dina dagar:</h2>
            
        {% for group in groups %}
            {% if groups|length > 1 %}<h5>{{ group.name }}</h5>{% endif %}
            <ul>
            {% for visit in group.visits %}
                {%- set visit_topic = topics[visit.topic_id] -%}
                <li><a href="{{ visit_topic.url }}">{{ visit_topic.name }}</a>: {{ visit.date }}</li>
            {% endfor %}
            </ul>
            {% for attribute, text in missing_text['group'] %}
                {% set extra = missing_text['group'][attribute] %}
                {% if groups|length > 1 %}
                    {% set extra = extra ~ ' (för grupp ' ~ group.name ~ ')'  %}
                {% endif %}
                {% if group[attribute] %}
                    {% set extra = extra ~ '. Vi har antecknat: ' ~ group[attribute] ~ ' --> Stämmer det?' %}
                {% else %}
                    {% set extra = extra ~ '.' %}
                {% endif %}

                {% set missing = missing|merge([extra]) %}
            {% endfor %}
        {% endfor %}

        {% set extra = missing_text['user']['mobil'] %}
        {% if user.mobil %}
            {% set extra = extra ~ '. Vi har antecknat: ' ~ user.mobil ~ ' --> Stämmer det?'  %}
        {% else %}
            {% set extra = extra ~ '.' %}
        {% endif %}
        {% set missing = missing|merge([extra]) %}

        {% if missing|length > 0 %}
            <h2>Vi behöver snarast veta:</h2>
            <ul>
            {% for missing_row in missing %}
                <li>{{ missing_row }}</li>
            {% endfor %}
            </ul>
        {% endif %}

        <p>Vänligen svara med ett mejl. Det går även bra att ringa oss.</p>
        <p>Ses snart!</p>
        <p>Hälsningar,<br>
        Friedrich från Naturskolan
        <p>073-6665275</p>
        <hr>
        <p>Sigtuna Naturskola är Sigtuna kommuns satsning på naturvetenskap, friluftsliv och hållbar utveckling. På uppdrag av BUN möter vi alla kommunens elever med temadagar för åk 2/3, åk 5 och åk 9.</p>
    {% endfor %}
{% endfor %}
{%- endblock -%}

